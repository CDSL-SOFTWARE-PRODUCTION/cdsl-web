---
import { headerMenu } from '@data/menu';
import Logo from '@components/Logo.astro';
import { Menu, X, ChevronDown } from 'lucide-astro';



// Get the current path to determine active menu item
const currentPath = Astro.url.pathname;

// Function to check if a link is the current page or a parent of the current page
const isCurrentPage = (link: string) => {
    if (link === '/') {
        return currentPath === '/' || currentPath === '';
    }
    return currentPath.startsWith(link);
};
---

<header class="fixed top-0 z-50 w-full left-0 transition-all duration-300 opacity-0" id="main-header">
    <div class="w-full px-4 md:px-8 py-4 md:py-6">
        <div class="flex justify-between items-center transition-all duration-300 bg-premium-navy/10 backdrop-blur-sm rounded-full px-6 py-2 border border-white/5" id="header-container">
            
            {/* Left: Logo */}
            <div class="flex-none flex items-center">
                <Logo />
            </div>

            {/* Center: Navigation - Evenly distributed */}
            <nav class="hidden lg:flex flex-grow justify-center px-10" aria-label="Site Navigation">
                <ul class="flex items-center justify-between w-full max-w-3xl">
                    {
                        headerMenu.map((item, index) => (
                            <li class="relative group">
                                <a
                                    href={item.link}
                                    class:list={[
                                        'text-[13px] font-medium uppercase tracking-[0.2em] transition-all duration-300 py-1 border-b border-transparent hover:border-premium-blue/30',
                                        isCurrentPage(item.link)
                                            ? 'text-premium-blue'
                                            : 'text-white/80 hover:text-premium-blue',
                                    ]}
                                    aria-current={isCurrentPage(item.link) ? 'page' : undefined}
                                    data-scramble="true"
                                    data-variant="header"
                                >
                                    {item.name}
                                    {item.children && item.showArrow && (
                                        <ChevronDown
                                            size={14}
                                            class="transform transition-transform inline-block ml-1 group-hover:rotate-180"
                                            aria-hidden="true"
                                        />
                                    )}
                                </a>
                                {item.children && (
                                    <ul
                                        class:list={[
                                            'submenu absolute mt-4 bg-premium-navy/95 backdrop-blur-md border border-white/10 rounded-none w-48 transition-all duration-300 opacity-0 invisible translate-y-2 group-hover:opacity-100 group-hover:visible group-hover:translate-y-0 overflow-hidden z-50 shadow-2xl p-0',
                                            'left-1/2 -translate-x-1/2',
                                        ]}
                                    >
                                        {item.children.map((child) => (
                                            <li>
                                                <a
                                                    href={child.link}
                                                    class:list={[
                                                        'block px-6 py-4 text-[10px] uppercase tracking-widest transition-colors duration-300 border-b border-white/5 last:border-none',
                                                        isCurrentPage(child.link)
                                                            ? 'bg-premium-blue/10 text-premium-blue'
                                                            : 'text-premium-gray hover:bg-premium-blue/5 hover:text-white',
                                                    ]}
                                                    aria-current={isCurrentPage(child.link) ? 'page' : undefined}
                                                    data-scramble="true"
                                                    data-variant="header"
                                                >
                                                    {child.name}
                                                </a>
                                            </li>
                                        ))}
                                    </ul>
                                )}
                            </li>
                        ))
                    }
                </ul>
            </nav>

            {/* Right: Time Display and Mobile Menu */}
            <div class="flex-none flex items-center justify-end gap-6 min-w-[120px]">
                <div class="hidden lg:flex flex-col items-end text-[10px] font-medium tracking-[0.15em] text-white/40" id="hanoi-time-display">
                    <span class="text-white/60 mb-0.5">HANOI, VN</span>
                    <span id="current-time" class="font-mono text-premium-blue/80">--:--</span>
                </div>

                {/* Mobile Menu Button */}
                <div class="lg:hidden">
                    <button
                        class="mobile-menu-button relative z-50 p-2 border-none cursor-pointer bg-transparent text-white hover:text-premium-blue transition-colors"
                        aria-label="Toggle Menu"
                        aria-expanded="false"
                    >
                        <span class="menu-icon block">
                            <Menu size={24} />
                        </span>
                        <span class="close-icon hidden">
                            <X size={24} />
                        </span>
                    </button>
                </div>
            </div>

            {/* Mobile Menu Panel */}
            <div
                class="mobile-menu fixed inset-0 z-40 px-6 pt-24 bg-premium-navy/95 backdrop-blur-xl lg:hidden hidden opacity-0 transition-opacity duration-300 overflow-y-auto"
            >
                <div class="flex flex-col h-full justify-between pb-8">
                    <ul class="flex flex-col gap-6">
                        {
                            headerMenu.map((item) => (
                                <li>
                                    <div class="text-white">
                                        <div class="flex items-center justify-between border-b border-white/10 pb-2">
                                            <a
                                                href={item.link}
                                                class:list={[
                                                    'text-2xl font-light uppercase tracking-[0.2em] transition-colors duration-300',
                                                    isCurrentPage(item.link)
                                                        ? 'text-premium-blue'
                                                        : 'text-white/60 hover:text-premium-blue',
                                                ]}
                                                aria-current={isCurrentPage(item.link) ? 'page' : undefined}
                                            >
                                                <span data-scramble="true" data-variant="header">{item.name}</span>
                                            </a>
                                            {item.children && (
                                                <button
                                                    class="mobile-submenu-button p-2 -mr-2 text-white/60 hover:text-white transition-colors"
                                                    aria-label={`Toggle ${item.name} submenu`}
                                                    aria-expanded="false"
                                                >
                                                    <ChevronDown
                                                        size={24}
                                                        class="transform transition-transform duration-200"
                                                    />
                                                </button>
                                            )}
                                        </div>
                                        {item.children && (
                                            <ul class="mobile-submenu ml-4 mt-4 space-y-4 hidden border-l border-white/10 pl-4" role="menu">
                                                {item.children.map((child) => (
                                                    <li role="none">
                                                        <a
                                                            href={child.link}
                                                            class:list={[
                                                                'block text-lg uppercase tracking-[0.15em] transition-colors duration-300',
                                                                isCurrentPage(child.link)
                                                                    ? 'text-premium-blue'
                                                                    : 'text-white/40 hover:text-white',
                                                            ]}
                                                            role="menuitem"
                                                            aria-current={
                                                                isCurrentPage(child.link) ? 'page' : undefined
                                                            }
                                                        >
                                                            <span data-scramble="true" data-variant="header">{child.name}</span>
                                                        </a>
                                                    </li>
                                                ))}
                                            </ul>
                                        )}
                                    </div>
                                </li>
                            ))
                        }
                    </ul>

                     <div class="mt-8 text-center text-white/50 text-sm">
                         <span class="block">Hanoi, Vietnam</span>
                         <span id="mobile-time-display">--:--</span>
                     </div>
                </div>
            </div>
        </div>
    </div>
</header>

<script>
    import { animate } from 'motion';

    function initHeader() {
        const header = document.getElementById('main-header');
        const headerContainer = document.getElementById('header-container');
        const currentTimeDisplay = document.getElementById('current-time');
        const mobileTimeDisplay = document.getElementById('mobile-time-display');

        // Entrance Animation (only if hidden/opacity is 0)
        if (header && getComputedStyle(header).opacity === '0') {
             animate(
                header,
                { y: [-20, 0], opacity: [0, 1] },
                { duration: 0.8, ease: [0.16, 1, 0.3, 1] }
            );
        }
        
        // Time Display
        const updateTime = () => {
            const now = new Date();
            const options: Intl.DateTimeFormatOptions = {
                timeZone: 'Asia/Bangkok',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            };
            const timeString = new Intl.DateTimeFormat('en-US', options).format(now);
            if (currentTimeDisplay) currentTimeDisplay.textContent = timeString;
            if (mobileTimeDisplay) mobileTimeDisplay.textContent = timeString;
        };

        // Initialize Time
        updateTime();
        if ((window as any)._headerTimeInterval) clearInterval((window as any)._headerTimeInterval);
        (window as any)._headerTimeInterval = setInterval(updateTime, 1000);



        // Scroll Effect
        const handleScroll = () => {
            if (window.scrollY > 20) {
                headerContainer?.classList.add('bg-premium-navy/80', 'backdrop-blur-md', 'shadow-md', 'py-3');
                headerContainer?.classList.remove('bg-premium-navy/10', 'py-2', 'md:py-4', 'border-white/5');
            } else {
                 headerContainer?.classList.add('bg-premium-navy/10', 'py-2', 'md:py-4', 'border-white/5');
                 headerContainer?.classList.remove('bg-premium-navy/80', 'backdrop-blur-md', 'shadow-md', 'py-3');
            }
        };

        // Attach scroll listener
        if ((window as any)._headerScrollHandler) {
            window.removeEventListener('scroll', (window as any)._headerScrollHandler);
        }
        (window as any)._headerScrollHandler = handleScroll;
        window.addEventListener('scroll', handleScroll);
        
        // Trigger once to set initial state
        handleScroll();

        // Initialize Mobile Menu
        initMobileMenu();

        // Initialize Mobile Submenus
        initMobileSubmenus();
    }


    
    // Mobile Menu Toggle
    function initMobileMenu() {
        const mobileMenuButton = document.querySelector('.mobile-menu-button');
        const mobileMenu = document.querySelector('.mobile-menu');

        if (mobileMenuButton && !(mobileMenuButton as any)._menuInitialized) {
            (mobileMenuButton as any)._menuInitialized = true;

            mobileMenuButton.addEventListener('click', () => {
                const isHidden = mobileMenu?.classList.contains('hidden');
                const mIcon = mobileMenuButton.querySelector('.menu-icon');
                const cIcon = mobileMenuButton.querySelector('.close-icon');

                if (isHidden) {
                    document.body.style.overflow = 'hidden';
                    mobileMenu?.classList.remove('hidden');
                    requestAnimationFrame(() => {
                        mobileMenu?.classList.remove('opacity-0');
                        mobileMenu?.classList.add('opacity-100');
                    });
                    mIcon?.classList.add('hidden');
                    cIcon?.classList.remove('hidden');
                } else {
                    document.body.style.overflow = '';
                    mobileMenu?.classList.add('opacity-0');
                    mobileMenu?.classList.remove('opacity-100');
                    setTimeout(() => {
                        mobileMenu?.classList.add('hidden');
                    }, 300);
                    mIcon?.classList.remove('hidden');
                    cIcon?.classList.add('hidden');
                }
            });
        }
    }

     // Mobile Submenu Toggle
    function initMobileSubmenus() {
        document.querySelectorAll('.mobile-submenu-button').forEach((button) => {
            if (!(button as any)._submenuInitialized) {
                (button as any)._submenuInitialized = true;

                button.addEventListener('click', () => {
                    const submenu = button.parentElement?.nextElementSibling as HTMLElement;
                    const chevron = button.querySelector('svg');

                    if (submenu) {
                        submenu.classList.toggle('hidden');
                        chevron?.classList.toggle('rotate-180');
                        const isExpanded = submenu.classList.contains('hidden') ? 'false' : 'true';
                        button.setAttribute('aria-expanded', isExpanded);
                    }
                });
            }
        });
    }

    // Run immediately
    initHeader();

    // Run on view transitions
    document.addEventListener('astro:page-load', initHeader);

</script>
